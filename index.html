let gpaData = {};
let selectedUniversities = [];
let allDepartments = new Set();

async function loadData() {
  const response = await fetch('data/gpa_data_통합_final.json');
  const data = await response.json();
  gpaData = data;

  Object.values(data).forEach(departments => {
    Object.values(departments).forEach(name => {
      allDepartments.add(name);
    });
  });

  updateUniversitySelect();
  renderTable();
}

function updateUniversitySelect() {
  const select = document.getElementById('universitySelect');
  select.innerHTML = '';

  const universities = Object.keys(gpaData).sort();
  universities.forEach(uni => {
    if (!selectedUniversities.includes(uni)) {
      const option = document.createElement('option');
      option.value = uni;
      option.textContent = uni;
      select.appendChild(option);
    }
  });
}

function renderTable() {
  const table = document.getElementById('gpaTable');
  table.innerHTML = '';

  const header = document.createElement('tr');
  const baseHeader = document.createElement('th');
  baseHeader.textContent = '70%컷';
  baseHeader.classList.add('fixed-col');
  header.appendChild(baseHeader);

  selectedUniversities.forEach((uni, index) => {
    const th = document.createElement('th');
    th.textContent = uni;
    th.className = `uni-color-${index % 5}`;
    const removeBtn = document.createElement('span');
    removeBtn.textContent = ' ❌';
    removeBtn.style.cursor = 'pointer';
    removeBtn.onclick = () => {
      selectedUniversities = selectedUniversities.filter(u => u !== uni);
      updateUniversitySelect();
      renderTable();
    };
    th.appendChild(removeBtn);
    header.appendChild(th);
  });

  table.appendChild(header);

  const scores = Array.from(
    new Set(
      selectedUniversities.flatMap(uni =>
        Object.keys(gpaData[uni] || {})
      )
    )
  ).sort((a, b) => parseFloat(a) - parseFloat(b));

  scores.forEach(score => {
    const row = document.createElement('tr');
    const scoreCell = document.createElement('td');
    scoreCell.textContent = score;
    scoreCell.classList.add('score-cell');
    row.appendChild(scoreCell);

    selectedUniversities.forEach((uni, index) => {
      const cell = document.createElement('td');
      cell.className = `uni-cell uni-color-${index % 5}`;
      if (gpaData[uni][score]) {
        cell.textContent = gpaData[uni][score];
      }
      row.appendChild(cell);
    });

    table.appendChild(row);
  });
}

document.getElementById('addCompare').addEventListener('click', () => {
  const select = document.getElementById('universitySelect');
  const value = select.value;
  if (value && !selectedUniversities.includes(value)) {
    selectedUniversities.push(value);
    updateUniversitySelect();
    renderTable();
  }
});

document.getElementById('reset').addEventListener('click', () => {
  selectedUniversities = [];
  updateUniversitySelect();
  renderTable();
});

document.getElementById('searchInput').addEventListener('input', e => {
  const keyword = e.target.value.toLowerCase();
  const rows = document.querySelectorAll('#gpaTable tr');
  rows.forEach((row, i) => {
    if (i === 0) return;
    const match = Array.from(row.cells).some(cell =>
      cell.textContent.toLowerCase().includes(keyword)
    );
    row.style.display = match ? '' : 'none';
    if (match) row.classList.add('highlight'); else row.classList.remove('highlight');
  });
});

document.getElementById('scrollTopBtn').addEventListener('click', () => {
  window.scrollTo({ top: 0, behavior: 'smooth' });
});

window.addEventListener('DOMContentLoaded', loadData);
